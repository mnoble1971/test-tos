declare upper;

input sessionStart = 0930;  # 9:30am ET

# fires once at 9:30 each day
def reset = SecondsFromTime(sessionStart) == 0 and SecondsFromTime(sessionStart)[1] != 0;

# High/Low for the rolling 9:30->9:30 sessions
def sessHigh = CompoundValue(1,
    if reset then high else Max(sessHigh[1], high),
    high
);

def sessLow = CompoundValue(1,
    if reset then low else Min(sessLow[1], low),
    low
);

# Capture the COMPLETED session at today's 9:30 (that was yesterday 9:30 -> today 9:30)
def baseHigh = CompoundValue(1,
    if reset then sessHigh[1] else baseHigh[1],
    sessHigh
);

def baseLow = CompoundValue(1,
    if reset then sessLow[1] else baseLow[1],
    sessLow
);

# Final: High/Low since yesterday 9:30 (carry forward and keep updating today)
def HighSinceY0930 =
    if SecondsFromTime(sessionStart) < 0 then sessHigh
    else Max(baseHigh, sessHigh);

def LowSinceY0930 =
    if SecondsFromTime(sessionStart) < 0 then sessLow
    else Min(baseLow, sessLow);

plot HighLine = HighSinceY0930;
plot LowLine  = LowSinceY0930;

HighLine.SetDefaultColor(Color.GREEN);
HighLine.SetLineWeight(1);

LowLine.SetDefaultColor(Color.RED);
LowLine.SetLineWeight(1);
